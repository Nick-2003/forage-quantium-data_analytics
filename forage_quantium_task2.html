<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Quantium Virtual Internship - Retail Strategy and Analytics - Task 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="forage_quantium_task2_files/libs/clipboard/clipboard.min.js"></script>
<script src="forage_quantium_task2_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="forage_quantium_task2_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="forage_quantium_task2_files/libs/quarto-html/popper.min.js"></script>
<script src="forage_quantium_task2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="forage_quantium_task2_files/libs/quarto-html/anchor.min.js"></script>
<link href="forage_quantium_task2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="forage_quantium_task2_files/libs/quarto-html/quarto-syntax-highlighting-53f539a478d6ecd1be31ce9fd30fd81c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="forage_quantium_task2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="forage_quantium_task2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="forage_quantium_task2_files/libs/bootstrap/bootstrap-b0d41b5f0083078154ce357f865e1e3e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Quantium Virtual Internship - Retail Strategy and Analytics - Task 2</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="solution-template-for-task-2" class="level1">
<h1>Solution template for Task 2</h1>
<p>This file is a solution template for the Task 2 of the Quantium Virtual Internship. It will walk you through the analysis, providing the scaffolding for your solution with gaps left for you to fill in yourself. Look for comments that say “over to you” for places where you need to add your own code!</p>
<p>Often, there will be hints about what to do or what function to use in the text leading up to a code block - if you need a bit of extra help on how to use a function, the internet has many excellent resources on R coding, which you can find using your favourite search engine.</p>
<section id="load-required-libraries-and-datasets" class="level2">
<h2 class="anchored" data-anchor-id="load-required-libraries-and-datasets">Load required libraries and datasets</h2>
<p>Note that you will need to install these libraries if you have never used these before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Point the filePath to where you have downloaded the datasets to and assign the data files to data.tables</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Over to you! Fill in the path to your working directory. If you are on a Windows machine, you will need to use forward slashes (/) instead of backshashes (\)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>filePath <span class="ot">&lt;-</span> <span class="st">"data/"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">paste0</span>(filePath,<span class="st">"QVI_data.csv"</span>))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Set themes for plots</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_update</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="select-control-stores" class="level2">
<h2 class="anchored" data-anchor-id="select-control-stores">Select control stores</h2>
<p>The client has selected store numbers 77, 86 and 88 as trial stores and want control stores to be established stores that are operational for the entire observation period.</p>
<p>We would want to match trial stores to control stores that are similar to the trial store prior to the trial period of Feb 2019 in terms of : - Monthly overall sales revenue - Monthly number of customers - Monthly number of transactions per customer Let’s first create the metrics of interest and filter to stores that are present throughout the pre-trial period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Calculate these measures over time for each store</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Add a new month ID column in the data with the format yyyymm.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data[, YEARMONTH <span class="sc">:</span><span class="er">=</span> <span class="fu">as.double</span>(<span class="fu">format</span>(<span class="fu">as.Date</span>(DATE), <span class="st">"%Y%m"</span>))] <span class="co"># Similar to data$YEARMONTH = format(as.Date(df$Date), "%Y-%m"), but can only be used in data.table and is generally more efficient for larger datasets</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># data[, YEARMONTH := year(DATE)*100 + month(DATE)]</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        LYLTY_CARD_NBR       DATE STORE_NBR TXN_ID PROD_NBR
                 &lt;int&gt;     &lt;IDat&gt;     &lt;int&gt;  &lt;int&gt;    &lt;int&gt;
     1:           1000 2018-10-17         1      1        5
     2:           1002 2018-09-16         1      2       58
     3:           1003 2019-03-07         1      3       52
     4:           1003 2019-03-08         1      4      106
     5:           1004 2018-11-02         1      5       96
    ---                                                    
246736:        2370651 2018-08-03        88 240350        4
246737:        2370701 2018-12-08        88 240378       24
246738:        2370751 2018-10-01        88 240394       60
246739:        2370961 2018-10-24        88 240480       70
246740:        2373711 2018-12-14        88 241815       16
                                       PROD_NAME PROD_QTY TOT_SALES PACK_SIZE
                                          &lt;char&gt;    &lt;int&gt;     &lt;num&gt;     &lt;int&gt;
     1:   Natural Chip        Compny SeaSalt175g        2       6.0       175
     2:    Red Rock Deli Chikn&amp;Garlic Aioli 150g        1       2.7       150
     3:    Grain Waves Sour    Cream&amp;Chives 210G        1       3.6       210
     4:   Natural ChipCo      Hony Soy Chckn175g        1       3.0       175
     5:           WW Original Stacked Chips 160g        1       1.9       160
    ---                                                                      
246736:         Dorito Corn Chp     Supreme 380g        2      13.0       380
246737:    Grain Waves         Sweet Chilli 210g        2       7.2       210
246738:     Kettle Tortilla ChpsFeta&amp;Garlic 150g        2       9.2       150
246739:  Tyrrells Crisps     Lightly Salted 165g        2       8.4       165
246740: Smiths Crinkle Chips Salt &amp; Vinegar 330g        2      11.4       330
             BRAND              LIFESTAGE PREMIUM_CUSTOMER YEARMONTH
            &lt;char&gt;                 &lt;char&gt;           &lt;char&gt;     &lt;num&gt;
     1:        NCC  YOUNG SINGLES/COUPLES          Premium    201810
     2:        Red  YOUNG SINGLES/COUPLES       Mainstream    201809
     3:      Grain         YOUNG FAMILIES           Budget    201903
     4:        NCC         YOUNG FAMILIES           Budget    201903
     5: Woolworths  OLDER SINGLES/COUPLES       Mainstream    201811
    ---                                                             
246736:    Doritos MIDAGE SINGLES/COUPLES       Mainstream    201808
246737:      Grain         YOUNG FAMILIES       Mainstream    201812
246738:     Kettle         YOUNG FAMILIES          Premium    201810
246739:   Tyrrells         OLDER FAMILIES           Budget    201810
246740:     Smiths  YOUNG SINGLES/COUPLES       Mainstream    201812</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Next, we define the measure calculations to use during the analysis.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Over to you! For each store and month calculate total sales, number of customers, transactions per customer, chips per customer and the average price per unit.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Hint: you can use uniqueN() to count distinct values in a column</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/1660124/how-to-sum-a-variable-by-group</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www.geeksforgeeks.org/count-unique-values-by-group-in-r/</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>measureOverTime <span class="ot">&lt;-</span> data[, .(<span class="at">totSales =</span> <span class="fu">sum</span>(TOT_SALES),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nCustomers =</span> <span class="fu">uniqueN</span>(LYLTY_CARD_NBR),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nTxnPerCust =</span> <span class="fu">uniqueN</span>(TXN_ID) <span class="sc">/</span> <span class="fu">uniqueN</span>(LYLTY_CARD_NBR),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nChipsPerTxn =</span> <span class="fu">sum</span>(PROD_QTY) <span class="sc">/</span> <span class="fu">uniqueN</span>(TXN_ID), <span class="co"># nChipsPerTxn = sum(TOT_SALES * PACK_SIZE) / uniqueN(TXN_ID),</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">avgPricePerUnit =</span> <span class="fu">sum</span>(PROD_QTY) <span class="sc">/</span> <span class="fu">uniqueN</span>(TXN_ID) <span class="co"># avgPricePerUnit = sum(TOT_SALES) / sum(TOT_SALES * PACK_SIZE)</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                        ), by <span class="ot">=</span> .(STORE_NBR, YEARMONTH)][<span class="fu">order</span>(STORE_NBR, YEARMONTH)]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>measureOverTime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      STORE_NBR YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
          &lt;int&gt;     &lt;num&gt;    &lt;num&gt;      &lt;int&gt;       &lt;num&gt;        &lt;num&gt;
   1:         1    201807    188.9         47    1.042553     1.183673
   2:         1    201808    168.4         41    1.000000     1.268293
   3:         1    201809    268.1         57    1.035088     1.203390
   4:         1    201810    175.4         39    1.025641     1.275000
   5:         1    201811    184.8         44    1.022727     1.222222
  ---                                                                 
3161:       272    201902    385.3         44    1.068182     1.893617
3162:       272    201903    421.9         48    1.062500     1.901961
3163:       272    201904    445.1         54    1.018519     1.909091
3164:       272    201905    314.6         34    1.176471     1.775000
3165:       272    201906    301.9         33    1.090909     1.888889
      avgPricePerUnit
                &lt;num&gt;
   1:        1.183673
   2:        1.268293
   3:        1.203390
   4:        1.275000
   5:        1.222222
  ---                
3161:        1.893617
3162:        1.901961
3163:        1.909091
3164:        1.775000
3165:        1.888889</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Filter to the pre-trial period and stores with full observation periods</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>storesWithFullObs <span class="ot">&lt;-</span> <span class="fu">unique</span>(measureOverTime[, .N, STORE_NBR][N <span class="sc">==</span> <span class="dv">12</span>, <span class="at">by =</span> STORE_NBR])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(measureOverTime[, .N, STORE_NBR], N == 12, by =
STORE_NBR): Ignoring by/keyby because 'j' is not supplied</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>storesWithFullObs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     STORE_NBR     N
         &lt;int&gt; &lt;int&gt;
  1:         1    12
  2:         2    12
  3:         3    12
  4:         4    12
  5:         5    12
 ---                
255:       268    12
256:       269    12
257:       270    12
258:       271    12
259:       272    12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>preTrialMeasures <span class="ot">&lt;-</span> measureOverTime[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> <span class="sc">&amp;</span> STORE_NBR <span class="sc">%in%</span> storesWithFullObs<span class="sc">$</span>STORE_NBR, ]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>preTrialMeasures</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      STORE_NBR YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
          &lt;int&gt;     &lt;num&gt;    &lt;num&gt;      &lt;int&gt;       &lt;num&gt;        &lt;num&gt;
   1:         1    201807    188.9         47    1.042553     1.183673
   2:         1    201808    168.4         41    1.000000     1.268293
   3:         1    201809    268.1         57    1.035088     1.203390
   4:         1    201810    175.4         39    1.025641     1.275000
   5:         1    201811    184.8         44    1.022727     1.222222
  ---                                                                 
1809:       272    201809    294.5         31    1.129032     1.971429
1810:       272    201810    405.1         41    1.146341     2.000000
1811:       272    201811    355.8         39    1.102564     1.930233
1812:       272    201812    363.1         43    1.000000     1.883721
1813:       272    201901    392.4         44    1.068182     1.914894
      avgPricePerUnit
                &lt;num&gt;
   1:        1.183673
   2:        1.268293
   3:        1.203390
   4:        1.275000
   5:        1.222222
  ---                
1809:        1.971429
1810:        2.000000
1811:        1.930233
1812:        1.883721
1813:        1.914894</code></pre>
</div>
</div>
<section id="calculation-of-similarity" class="level3">
<h3 class="anchored" data-anchor-id="calculation-of-similarity">Calculation of similarity</h3>
<p>Now we need to work out a way of ranking how similar each potential control store is to the trial store. We can calculate how correlated the performance of each store is to the trial store. Let’s write a function for this so that we don’t have to calculate this for each trial store and control store pair.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Create a function to calculate correlation for a measure, looping through each control store.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Let's define inputTable as a metric table with potential comparison stores, metricCol as the store metric used to calculate correlation on, and storeComparison as the store number of the trial store.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>calculateCorrelation <span class="ot">&lt;-</span> <span class="cf">function</span>(inputTable, metricCol, storeComparison) {</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  calcCorrTable <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">Store1 =</span> <span class="fu">numeric</span>(), <span class="at">Store2 =</span> <span class="fu">numeric</span>(), <span class="at">corr_measure =</span> <span class="fu">numeric</span>())</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  storeNumbers <span class="ot">&lt;-</span> storesWithFullObs[, STORE_NBR]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> storeNumbers) {</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    calculatedMeasure <span class="ot">=</span> <span class="fu">data.table</span>(<span class="st">"Store1"</span> <span class="ot">=</span> storeComparison, </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Store2"</span> <span class="ot">=</span> i,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="co"># "corr_measure" = cor(</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                                   <span class="co">#   inputTable[STORE_NBR == storeComparison, get(metricCol)],</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                                   <span class="co">#   inputTable[STORE_NBR == i, get(metricCol)],</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                                   <span class="co">#   use = "complete.obs",</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="co">#   )</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"corr_measure"</span> <span class="ot">=</span> <span class="fu">cor</span>(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                                     inputTable[STORE_NBR<span class="sc">==</span> storeComparison, <span class="fu">eval</span>(metricCol)], </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                                     inputTable[STORE_NBR<span class="sc">==</span> i, <span class="fu">eval</span>(metricCol)])</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                                   )</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    calcCorrTable <span class="ot">&lt;-</span> <span class="fu">rbind</span>(calcCorrTable, calculatedMeasure)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(calcCorrTable)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Apart from correlation, we can also calculate a standardised metric based on the absolute difference between the trial store’s performance and each control store’s performance. Let’s write a function for this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Create a function to calculate a standardised magnitude distance for a measure, looping through each control store</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>calculateMagnitudeDistance <span class="ot">&lt;-</span> <span class="cf">function</span>(inputTable, metricCol, storeComparison) {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  calcDistTable <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">Store1 =</span> <span class="fu">numeric</span>(), <span class="at">Store2 =</span> <span class="fu">numeric</span>(), <span class="at">YEARMONTH =</span> <span class="fu">numeric</span>(), <span class="at">measure =</span> <span class="fu">numeric</span>())</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  storeNumbers <span class="ot">&lt;-</span> <span class="fu">unique</span>(inputTable[, STORE_NBR])</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> storeNumbers) {</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    calculatedMeasure <span class="ot">=</span> <span class="fu">data.table</span>(<span class="st">"Store1"</span> <span class="ot">=</span> storeComparison, </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Store2"</span> <span class="ot">=</span> i, </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"YEARMONTH"</span> <span class="ot">=</span> inputTable[STORE_NBR <span class="sc">==</span> storeComparison, YEARMONTH],</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"measure"</span> <span class="ot">=</span> <span class="fu">abs</span>(inputTable[STORE_NBR <span class="sc">==</span> storeComparison, <span class="fu">eval</span>(metricCol)] <span class="sc">-</span> inputTable[STORE_NBR <span class="sc">==</span> i, <span class="fu">eval</span>(metricCol)])</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                                   )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    calcDistTable <span class="ot">&lt;-</span> <span class="fu">rbind</span>(calcDistTable, calculatedMeasure)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### Standardise the magnitude distance so that the measure ranges from 0 to 1</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  minMaxDist <span class="ot">&lt;-</span> calcDistTable[, .(<span class="at">minDist =</span> <span class="fu">min</span>(measure), <span class="at">maxDist =</span> <span class="fu">max</span>(measure)), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"YEARMONTH"</span>)]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  distTable <span class="ot">&lt;-</span> <span class="fu">merge</span>(calcDistTable, minMaxDist, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"YEARMONTH"</span>))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  distTable[, magnitudeMeasure <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span> <span class="sc">-</span> (measure <span class="sc">-</span> minDist)<span class="sc">/</span>(maxDist <span class="sc">-</span> minDist)]</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  finalDistTable <span class="ot">&lt;-</span> distTable[, .(<span class="at">mag_measure =</span> <span class="fu">mean</span>(magnitudeMeasure)), by <span class="ot">=</span> .(Store1, Store2)]</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(finalDistTable)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s use the functions to find the control stores! We’ll select control stores based on how similar monthly total sales in dollar amounts and monthly number of customers are to the trial stores. So we will need to use our functions to get four scores, two for each of total sales and total customers. s</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Use the function you created to calculate correlations against store 77 using total sales and number of customers.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: Refer back to the input names of the functions we created.</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>trial_store <span class="ot">&lt;-</span> <span class="dv">77</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>corr_nSales <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(measureOverTime, <span class="fu">quote</span>(totSales), trial_store)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>corr_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(measureOverTime, <span class="fu">quote</span>(nCustomers), trial_store)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Then, use the functions for calculating magnitude.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>magnitude_nSales <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="fu">quote</span>(totSales), trial_store)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>magnitude_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="fu">quote</span>(nCustomers), trial_store)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>corr_nSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Store1 Store2 corr_measure
      &lt;num&gt;  &lt;num&gt;        &lt;num&gt;
  1:     77      1   0.01324440
  2:     77      2   0.24832859
  3:     77      3  -0.05582804
  4:     77      4  -0.27175866
  5:     77      5  -0.30919008
 ---                           
255:     77    268   0.39612833
256:     77    269  -0.51342549
257:     77    270   0.22270957
258:     77    271   0.12081481
259:     77    272  -0.08235309</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>corr_nCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Store1 Store2 corr_measure
      &lt;num&gt;  &lt;num&gt;        &lt;num&gt;
  1:     77      1   0.18012585
  2:     77      2   0.30284886
  3:     77      3   0.01671338
  4:     77      4  -0.38213911
  5:     77      5  -0.33656294
 ---                           
255:     77    268   0.48111929
256:     77    269  -0.29983081
257:     77    270  -0.03124355
258:     77    271  -0.14688267
259:     77    272   0.13177827</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>magnitude_nSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Store1 Store2 mag_measure
      &lt;num&gt;  &lt;num&gt;       &lt;num&gt;
  1:     77      1   0.9525366
  2:     77      2   0.9360698
  3:     77      3   0.3449959
  4:     77      4   0.1808497
  5:     77      5   0.5644568
 ---                          
255:     77    268   0.9624888
256:     77    269   0.4546411
257:     77    270   0.4579233
258:     77    271   0.5720207
259:     77    272   0.8917476</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>magnitude_nCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Store1 Store2 mag_measure
      &lt;num&gt;  &lt;num&gt;       &lt;num&gt;
  1:     77      1   0.9391149
  2:     77      2   0.9087322
  3:     77      3   0.3431594
  4:     77      4   0.2022603
  5:     77      5   0.5135798
 ---                          
255:     77    268   0.9435154
256:     77    269   0.3624207
257:     77    270   0.3910055
258:     77    271   0.5245199
259:     77    272   0.9481501</code></pre>
</div>
</div>
<p>We’ll need to combine the all the scores calculated using our function to create a composite score to rank on.</p>
<p>Let’s take a simple average of the correlation and magnitude scores for each driver. Note that if we consider it more important for the trend of the drivers to be similar, we can increase the weight of the correlation score (a simple average gives a weight of 0.5 to the corr_weight) or if we consider the absolute size of the drivers to be more important, we can lower the weight of the correlation score.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Create a combined score composed of correlation and magnitude, by first merging the correlations table with the magnitude table.</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: A simple average on the scores would be 0.5 * corr_measure + 0.5 * mag_measure</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>corr_weight <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>score_nSales <span class="ot">&lt;-</span> <span class="fu">merge</span>(corr_nSales, magnitude_nSales, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))[, scoreNSales <span class="sc">:</span><span class="er">=</span> corr_weight <span class="sc">*</span> corr_measure <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight) <span class="sc">*</span> mag_measure]</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>score_nCustomers <span class="ot">&lt;-</span> <span class="fu">merge</span>(corr_nCustomers, magnitude_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))[, scoreNCust <span class="sc">:</span><span class="er">=</span> corr_weight <span class="sc">*</span> corr_measure <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight) <span class="sc">*</span> mag_measure]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>score_nSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;Store1, Store2&gt;
     Store1 Store2 corr_measure mag_measure scoreNSales
      &lt;num&gt;  &lt;num&gt;        &lt;num&gt;       &lt;num&gt;       &lt;num&gt;
  1:     77      1   0.01324440   0.9525366  0.71771359
  2:     77      2   0.24832859   0.9360698  0.76413450
  3:     77      3  -0.05582804   0.3449959  0.24478992
  4:     77      4  -0.27175866   0.1808497  0.06769757
  5:     77      5  -0.30919008   0.5644568  0.34604507
 ---                                                   
255:     77    268   0.39612833   0.9624888  0.82089870
256:     77    269  -0.51342549   0.4546411  0.21262445
257:     77    270   0.22270957   0.4579233  0.39911988
258:     77    271   0.12081481   0.5720207  0.45921921
259:     77    272  -0.08235309   0.8917476  0.64822245</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>score_nCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;Store1, Store2&gt;
     Store1 Store2 corr_measure mag_measure scoreNCust
      &lt;num&gt;  &lt;num&gt;        &lt;num&gt;       &lt;num&gt;      &lt;num&gt;
  1:     77      1   0.18012585   0.9391149 0.74936767
  2:     77      2   0.30284886   0.9087322 0.75726139
  3:     77      3   0.01671338   0.3431594 0.26154791
  4:     77      4  -0.38213911   0.2022603 0.05616046
  5:     77      5  -0.33656294   0.5135798 0.30104409
 ---                                                  
255:     77    268   0.48111929   0.9435154 0.82791640
256:     77    269  -0.29983081   0.3624207 0.19685786
257:     77    270  -0.03124355   0.3910055 0.28544322
258:     77    271  -0.14688267   0.5245199 0.35666925
259:     77    272   0.13177827   0.9481501 0.74405712</code></pre>
</div>
</div>
<p>Now we have a score for each of total number of sales and number of customers. Let’s combine the two via a simple average.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Combine scores across the drivers by first merging our sales scores and customer scores into a single table</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>score_Control <span class="ot">&lt;-</span> <span class="fu">merge</span>(score_nSales, score_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>score_Control[, finalControlScore <span class="sc">:</span><span class="er">=</span> scoreNSales <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">+</span> scoreNCust <span class="sc">*</span> <span class="fl">0.5</span>]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>score_Control</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;Store1, Store2&gt;
     Store1 Store2 corr_measure.x mag_measure.x scoreNSales corr_measure.y
      &lt;num&gt;  &lt;num&gt;          &lt;num&gt;         &lt;num&gt;       &lt;num&gt;          &lt;num&gt;
  1:     77      1     0.01324440     0.9525366  0.71771359     0.18012585
  2:     77      2     0.24832859     0.9360698  0.76413450     0.30284886
  3:     77      3    -0.05582804     0.3449959  0.24478992     0.01671338
  4:     77      4    -0.27175866     0.1808497  0.06769757    -0.38213911
  5:     77      5    -0.30919008     0.5644568  0.34604507    -0.33656294
 ---                                                                      
255:     77    268     0.39612833     0.9624888  0.82089870     0.48111929
256:     77    269    -0.51342549     0.4546411  0.21262445    -0.29983081
257:     77    270     0.22270957     0.4579233  0.39911988    -0.03124355
258:     77    271     0.12081481     0.5720207  0.45921921    -0.14688267
259:     77    272    -0.08235309     0.8917476  0.64822245     0.13177827
     mag_measure.y scoreNCust finalControlScore
             &lt;num&gt;      &lt;num&gt;             &lt;num&gt;
  1:     0.9391149 0.74936767        0.73354063
  2:     0.9087322 0.75726139        0.76069795
  3:     0.3431594 0.26154791        0.25316891
  4:     0.2022603 0.05616046        0.06192902
  5:     0.5135798 0.30104409        0.32354458
 ---                                           
255:     0.9435154 0.82791640        0.82440755
256:     0.3624207 0.19685786        0.20474115
257:     0.3910055 0.28544322        0.34228155
258:     0.5245199 0.35666925        0.40794423
259:     0.9481501 0.74405712        0.69613979</code></pre>
</div>
</div>
<p>The store with the highest score is then selected as the control store since it is most similar to the trial store.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Select control stores based on the highest matching store (closest to 1 but not the store itself, i.e. the second ranked highest store)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Select the most appropriate control store for trial store 77 by finding the store with the highest final score.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> score_Control[Store1 <span class="sc">==</span> trial_store, </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                               ][<span class="fu">order</span>(<span class="sc">-</span>finalControlScore)][<span class="dv">2</span>, Store2] <span class="co"># 35 </span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>score_Control[Store1 <span class="sc">==</span> trial_store, ][<span class="fu">order</span>(<span class="sc">-</span>finalControlScore)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Store1 Store2 corr_measure.x mag_measure.x scoreNSales corr_measure.y
      &lt;num&gt;  &lt;num&gt;          &lt;num&gt;         &lt;num&gt;       &lt;num&gt;          &lt;num&gt;
  1:     77     77     1.00000000    1.00000000  1.00000000     1.00000000
  2:     77    167     0.69859398    0.95465879  0.89064259     0.76789736
  3:     77    233     0.57939112    0.98589670  0.88427031     0.58863673
  4:     77     53     0.66597743    0.97211427  0.89558006     0.64250437
  5:     77     35     0.78217461    0.90767119  0.87629704     0.82156859
 ---                                                                      
255:     77     75    -0.45232268    0.31570975  0.12370165    -0.42318912
256:     77    203    -0.14385228    0.21553698  0.12568966    -0.08889189
257:     77     58    -0.04746112    0.18395901  0.12610398    -0.05134850
258:     77    226     0.32373677    0.06137464  0.12696517     0.20100645
259:     77      4    -0.27175866    0.18084965  0.06769757    -0.38213911
     mag_measure.y scoreNCust finalControlScore
             &lt;num&gt;      &lt;num&gt;             &lt;num&gt;
  1:    1.00000000 1.00000000        1.00000000
  2:    0.95234083 0.90622996        0.89843628
  3:    0.99096346 0.89038177        0.88732604
  4:    0.94852066 0.87201659        0.88379832
  5:    0.89956065 0.88006263        0.87817984
 ---                                           
255:    0.34198878 0.15069431        0.13719798
256:    0.22748763 0.14839275        0.13704121
257:    0.17338115 0.11719874        0.12165136
258:    0.05006858 0.08780305        0.10738411
259:    0.20226032 0.05616046        0.06192902</code></pre>
</div>
</div>
<p>Now that we have found a control store, let’s check visually if the drivers are indeed similar in the period before the trial. We’ll look at total sales first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Visual checks on trends based on the drivers</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next, number of customers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Conduct visual checks on customer count trends by comparing the trial store to the control store and other stores.</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: Look at the previous plot.</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### ??? PLOT DOES NOT LOOK RIGHT</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>                                  ][, nCustomers <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(measureOverTimeCusts[, `:=`(Store_type,
ifelse(STORE_NBR == : 67.202290 (type 'double') at RHS position 1
out-of-range(NA) or truncated (precision lost) when assigning to type 'integer'
(column 4 named 'nCustomers')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="assessment-of-trial" class="level2">
<h2 class="anchored" data-anchor-id="assessment-of-trial">Assessment of trial</h2>
<p>The trial period goes from the start of February 2019 to April 2019. We now want to see if there has been an uplift in overall chip sales. We’ll start with scaling the control store’s sales to a level similar to control for any differences between the two stores outside of the trial period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control sales to match pre-trial trial store sales</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>scaledControlSales <span class="ot">&lt;-</span> measureOverTimeSales[STORE_NBR <span class="sc">==</span> control_store, ][ , controlSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> scalingFactorForControlSales]</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>scaledControlSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have comparable sales figures for the control store, we can calculate the percentage difference between the scaled control sales and the trial store’s sales during the trial period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the percentage difference between scaled control sales and trial sales</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlSales,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeSales[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> (((totSales.y <span class="sc">-</span> controlSales) <span class="sc">/</span> controlSales)) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff &lt;- merge(</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   scaledControlSales[, .(YEARMONTH, controlSales)], </span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   measureOverTimeSales[STORE_NBR == trial_store, .(YEARMONTH, trialSales = totSales)], </span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   by = "YEARMONTH"</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co"># )[, percentageDiff := ((controlSales / trialSales) - 1) * 100]</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see if the difference is significant!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff]) <span class="co"># 6.801061%</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Note that there are 8 months in the pre-trial period, hence 8 - 1 = 7 degrees of freedom</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores.</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the t-values for the trial months. After that, find the 95th percentile of the t distribution with the appropriate degrees of freedom to check whether the hypothesis is statistically significant.</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: The test statistic here is (x - u)/standard deviation</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>percentageDiff[, tValue <span class="sc">:</span><span class="er">=</span> (percentageDiff <span class="sc">-</span> <span class="dv">0</span>)<span class="sc">/</span>stdDev][, TransactionMonth <span class="sc">:</span><span class="er">=</span> TransactionMonth.x][, .(TransactionMonth, percentageDiff, tValue, <span class="at">significance =</span> (tValue <span class="sc">&gt;</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    TransactionMonth percentageDiff      tValue significance
              &lt;Date&gt;          &lt;num&gt;       &lt;num&gt;       &lt;lgcl&gt;
 1:       2018-07-01     -5.9966350 -0.31454880        FALSE
 2:       2018-08-01     -7.1495390 -0.37502348        FALSE
 3:       2018-09-01    -18.6262633 -0.97702607        FALSE
 4:       2018-10-01     -6.0810734 -0.31897795        FALSE
 5:       2018-11-01     -1.0573459 -0.05546225        FALSE
 6:       2018-12-01     27.9492522  1.46605616        FALSE
 7:       2019-01-01     31.4195945  1.64809025        FALSE
 8:       2019-02-01      7.9558416  0.41731745        FALSE
 9:       2019-03-01     11.5131997  0.60391589        FALSE
10:       2019-04-01     12.2390106  0.64198773        FALSE
11:       2019-05-01     -9.7846783 -0.51324765        FALSE
12:       2019-06-01      0.9504745  0.04985640        FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff[YEARMONTH &gt;= 201902 &amp; YEARMONTH &lt;= 201904, </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   .(TransactionMonth = TransactionMonth.x, </span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     percentageDiff, </span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     tValue = percentageDiff / stdDev, </span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     significance = (percentageDiff / stdDev) &gt; qt(0.95, df = degreesOfFreedom))]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can observe that the t-value is much larger than the 95th percentile value of the t-distribution for March and April - i.e.&nbsp;the increase in sales in the trial store in March and April is statistically greater than in the control store.</p>
<p>Let’s create a more visual version of this by plotting the sales of the control store, the sales of the trial stores and the 95th percentile value of sales of the control store.</p>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store total sales</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Create new variables Store_type, totSales and TransactionMonth in the data table.</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### ??? PLOT DOES NOT LOOK RIGHT</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>                                 ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>                                 ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting these in one nice graph</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The results show that the trial in store 77 is significantly different to its control store in the trial period as the trial store performance lies outside the 5% to 95% confidence interval of the control store in two of the three trial months. Let’s have a look at assessing this for number of customers as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### This would be a repeat of the steps before for total sales</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control customers to match pre-trial trial store customers</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Compute a scaling factor to align control store customer counts to our trial store. Then, apply the scaling factor to control store customer counts. Finally, calculate the percentage difference between scaled control store customers and trial customers.</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCust <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>scaledControlCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[STORE_NBR <span class="sc">==</span> control_store, ][ , controlCustomers <span class="sc">:</span><span class="er">=</span> nCustomers <span class="sc">*</span> scalingFactorForControlCust]</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlCustomers,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeCusts[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> ((nCustomers.y <span class="sc">-</span> controlCustomers) <span class="sc">/</span> controlCustomers) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s again see if the difference is significant visually!</p>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store number of customers</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, nCusts <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>                                          ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>) </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>                                          ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>                                         ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>                                         ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="st">interval"</span>]</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastCustomers, pastCustomers_Controls95, pastCustomers_Controls5)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Plot everything into one nice graph.</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: geom_rect creates a rectangle in the plot. Use this to highlight the trial period in our graph.</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCusts, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="supposed-results" class="level3">
<h3 class="anchored" data-anchor-id="supposed-results">Supposed results</h3>
<section id="visual-checks" class="level4">
<h4 class="anchored" data-anchor-id="visual-checks">Visual checks</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> <span class="dv">233</span> <span class="co"># Supposed result</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Visual checks on trends based on the drivers</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                                  ][, nCustomers <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(measureOverTimeCusts[, `:=`(Store_type,
ifelse(STORE_NBR == : 66.923664 (type 'double') at RHS position 1
out-of-range(NA) or truncated (precision lost) when assigning to type 'integer'
(column 4 named 'nCustomers')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-of-results" class="level4">
<h4 class="anchored" data-anchor-id="comparison-of-results">Comparison of results</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control sales to match pre-trial trial store sales</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>scaledControlSales <span class="ot">&lt;-</span> measureOverTimeSales[STORE_NBR <span class="sc">==</span> control_store, ][ , controlSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> scalingFactorForControlSales]</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>scaledControlSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have comparable sales figures for the control store, we can calculate the percentage difference between the scaled control sales and the trial store’s sales during the trial period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the percentage difference between scaled control sales and trial sales</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlSales,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeSales[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> (((totSales.y <span class="sc">-</span> controlSales) <span class="sc">/</span> controlSales)) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff &lt;- merge(</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   scaledControlSales[, .(YEARMONTH, controlSales)], </span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   measureOverTimeSales[STORE_NBR == trial_store, .(YEARMONTH, trialSales = totSales)], </span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   by = "YEARMONTH"</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># )[, percentageDiff := ((controlSales / trialSales) - 1) * 100]</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="significance-test-for-sales" class="level4">
<h4 class="anchored" data-anchor-id="significance-test-for-sales">Significance test for sales</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff]) <span class="co"># 6.801061%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Note that there are 8 months in the pre-trial period, hence 8 - 1 = 7 degrees of freedom</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores.</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the t-values for the trial months. After that, find the 95th percentile of the t distribution with the appropriate degrees of freedom to check whether the hypothesis is statistically significant.</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: The test statistic here is (x - u)/standard deviation</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>percentageDiff[, tValue <span class="sc">:</span><span class="er">=</span> (percentageDiff <span class="sc">-</span> <span class="dv">0</span>)<span class="sc">/</span>stdDev][, TransactionMonth <span class="sc">:</span><span class="er">=</span> TransactionMonth.x][, .(TransactionMonth, percentageDiff, tValue, <span class="at">significance =</span> (tValue <span class="sc">&gt;</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    TransactionMonth percentageDiff    tValue significance
              &lt;Date&gt;          &lt;num&gt;     &lt;num&gt;       &lt;lgcl&gt;
 1:       2018-07-01      -56.09173 -11.41726        FALSE
 2:       2018-08-01      -57.72860 -11.75044        FALSE
 3:       2018-09-01      -63.49272 -12.92371        FALSE
 4:       2018-10-01      -67.89944 -13.82068        FALSE
 5:       2018-11-01      -62.02012 -12.62396        FALSE
 6:       2018-12-01      -58.95022 -11.99910        FALSE
 7:       2019-01-01      -68.74206 -13.99219        FALSE
 8:       2019-02-01      -61.94734 -12.60915        FALSE
 9:       2019-03-01      -58.46268 -11.89986        FALSE
10:       2019-04-01      -56.50099 -11.50057        FALSE
11:       2019-05-01      -53.11873 -10.81212        FALSE
12:       2019-06-01      -58.49238 -11.90591        FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff[YEARMONTH &gt;= 201902 &amp; YEARMONTH &lt;= 201904, </span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   .(TransactionMonth = TransactionMonth.x, </span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     percentageDiff, </span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     tValue = percentageDiff / stdDev, </span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     significance = (percentageDiff / stdDev) &gt; qt(0.95, df = degreesOfFreedom))]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store total sales</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Create new variables Store_type, totSales and TransactionMonth in the data table.</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### ??? PLOT DOES NOT LOOK RIGHT</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>                                 ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>                                 ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting these in one nice graph</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="significance-test-for-customers" class="level4">
<h4 class="anchored" data-anchor-id="significance-test-for-customers">Significance test for customers</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### This would be a repeat of the steps before for total sales</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control customers to match pre-trial trial store customers</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Compute a scaling factor to align control store customer counts to our trial store. Then, apply the scaling factor to control store customer counts. Finally, calculate the percentage difference between scaled control store customers and trial customers.</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCust <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>scaledControlCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[STORE_NBR <span class="sc">==</span> control_store, ][ , controlCustomers <span class="sc">:</span><span class="er">=</span> nCustomers <span class="sc">*</span> scalingFactorForControlCust]</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlCustomers,</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeCusts[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> ((nCustomers.y <span class="sc">-</span> controlCustomers) <span class="sc">/</span> controlCustomers) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store number of customers</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, nCusts <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>                                          ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>) </span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>                                          ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>                                         ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>                                         ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="st">interval"</span>]</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastCustomers, pastCustomers_Controls95, pastCustomers_Controls5)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Plot everything into one nice graph.</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: geom_rect creates a rectangle in the plot. Use this to highlight the trial period in our graph.</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCusts, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s repeat finding the control store and assessing the impact of the trial for each of the other two trial stores.</p>
</section>
</section>
</section>
<section id="trial-store-86" class="level2">
<h2 class="anchored" data-anchor-id="trial-store-86">Trial store 86</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the metrics below as we did for the first trial store.</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>measureOverTime <span class="ot">&lt;-</span> data[, .(<span class="at">totSales =</span> <span class="fu">sum</span>(TOT_SALES),</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nCustomers =</span> <span class="fu">uniqueN</span>(LYLTY_CARD_NBR),</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nTxnPerCust =</span> <span class="fu">uniqueN</span>(TXN_ID) <span class="sc">/</span> <span class="fu">uniqueN</span>(LYLTY_CARD_NBR),</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nChipsPerTxn =</span> <span class="fu">sum</span>(TOT_SALES <span class="sc">*</span> PACK_SIZE) <span class="sc">/</span> <span class="fu">uniqueN</span>(TXN_ID),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">avgPricePerUnit =</span> <span class="fu">sum</span>(TOT_SALES) <span class="sc">/</span> <span class="fu">sum</span>(TOT_SALES <span class="sc">*</span> PACK_SIZE))</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                        , by <span class="ot">=</span> .(STORE_NBR, YEARMONTH)][<span class="fu">order</span>(STORE_NBR, YEARMONTH)]</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>measureOverTime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      STORE_NBR YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
          &lt;int&gt;     &lt;num&gt;    &lt;num&gt;      &lt;int&gt;       &lt;num&gt;        &lt;num&gt;
   1:         1    201807    188.9         47    1.042553     680.1449
   2:         1    201808    168.4         41    1.000000     747.8268
   3:         1    201809    268.1         57    1.035088     820.5407
   4:         1    201810    175.4         39    1.025641     715.7175
   5:         1    201811    184.8         44    1.022727     733.2489
  ---                                                                 
3161:       272    201902    385.3         44    1.068182    1466.9617
3162:       272    201903    421.9         48    1.062500    1536.5392
3163:       272    201904    445.1         54    1.018519    1323.6982
3164:       272    201905    314.6         34    1.176471    1453.3675
3165:       272    201906    301.9         33    1.090909    1515.6139
      avgPricePerUnit
                &lt;num&gt;
   1:     0.005668060
   2:     0.005492337
   3:     0.005537895
   4:     0.006126719
   5:     0.005600645
  ---                
3161:     0.005588334
3162:     0.005383884
3163:     0.006113725
3164:     0.005411570
3165:     0.005533145</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Use the functions we created earlier to calculate correlations and magnitude for each potential control store</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>trial_store <span class="ot">&lt;-</span> <span class="dv">86</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>corr_nSales <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(measureOverTime, <span class="fu">quote</span>(totSales), trial_store)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>corr_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(measureOverTime, <span class="fu">quote</span>(nCustomers), trial_store)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>magnitude_nSales <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="fu">quote</span>(totSales), trial_store)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>magnitude_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="fu">quote</span>(nCustomers), trial_store)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="do">#### Now, create a combined score composed of correlation and magnitude</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>corr_weight <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>score_nSales <span class="ot">&lt;-</span> <span class="fu">merge</span>(corr_nSales, magnitude_nSales, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))[, scoreNSales <span class="sc">:</span><span class="er">=</span> corr_weight <span class="sc">*</span> corr_measure <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight) <span class="sc">*</span> mag_measure]</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>score_nCustomers <span class="ot">&lt;-</span> <span class="fu">merge</span>(corr_nCustomers, magnitude_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))[, scoreNCust <span class="sc">:</span><span class="er">=</span> corr_weight <span class="sc">*</span> corr_measure <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight) <span class="sc">*</span> mag_measure]</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="do">#### Finally, combine scores across the drivers using a simple average.</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>score_Control <span class="ot">&lt;-</span> <span class="fu">merge</span>(score_nSales, score_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>score_Control[, finalControlScore <span class="sc">:</span><span class="er">=</span> scoreNSales <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">+</span> scoreNCust <span class="sc">*</span> <span class="fl">0.5</span>]</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="do">#### Select control stores based on the highest matching store</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="do">#### (closest to 1 but not the store itself, i.e. the second ranked highest store)</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="do">#### Select control store for trial store 86</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> score_Control[Store1 <span class="sc">==</span> trial_store, </span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>                               ][<span class="fu">order</span>(<span class="sc">-</span>finalControlScore)][<span class="dv">2</span>, Store2]</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>score_Control[Store1 <span class="sc">==</span> trial_store, ][<span class="fu">order</span>(<span class="sc">-</span>finalControlScore)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Store1 Store2 corr_measure.x mag_measure.x scoreNSales corr_measure.y
      &lt;num&gt;  &lt;num&gt;          &lt;num&gt;         &lt;num&gt;       &lt;num&gt;          &lt;num&gt;
  1:     86     86      1.0000000    1.00000000  1.00000000      1.0000000
  2:     86    229      0.5974183    0.91998372  0.83934237      0.7010435
  3:     86    109      0.6254347    0.95027229  0.86906289      0.3787452
  4:     86    155      0.4507953    0.96142329  0.83376628      0.3775724
  5:     86    147      0.5423492    0.90240317  0.81238967      0.5489033
 ---                                                                      
255:     86    135     -0.4747890    0.02462848 -0.10022588     -0.1142997
256:     86     52     -0.4313272    0.03246583 -0.08348243     -0.1934802
257:     86     42     -0.3325795    0.01848270 -0.06928284     -0.3786802
258:     86    161     -0.3171562    0.02782740 -0.05841849     -0.5430203
259:     86    192     -0.4072344    0.03024539 -0.07912456     -0.6148885
     mag_measure.y   scoreNCust finalControlScore
             &lt;num&gt;        &lt;num&gt;             &lt;num&gt;
  1:    1.00000000  1.000000000        1.00000000
  2:    0.93739499  0.878307114        0.85882474
  3:    0.94740687  0.805241455        0.83715217
  4:    0.97210770  0.823473867        0.82862007
  5:    0.90276057  0.814296244        0.81334295
 ---                                             
255:    0.04155252  0.002589469       -0.04881821
256:    0.03856156 -0.019448892       -0.05146566
257:    0.03891607 -0.065482992       -0.06738292
258:    0.04621596 -0.101093114       -0.07975580
259:    0.05578336 -0.111884598       -0.09550458</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># control_store &lt;- 155 # Supposed result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looks like store 155 will be a control store for trial store 86. Again, let’s check visually if the drivers are indeed similar in the period before the trial. We’ll look at total sales first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Conduct visual checks on trends based on the drivers</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Great, sales are trending in a similar way. Next, number of customers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you again! Conduct visual checks on trends based on the drivers</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>                                  ][, nCustomers <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(measureOverTimeCusts[, `:=`(Store_type,
ifelse(STORE_NBR == : 66.832061 (type 'double') at RHS position 1
out-of-range(NA) or truncated (precision lost) when assigning to type 'integer'
(column 4 named 'nCustomers')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Good, the trend in number of customers is also similar. Let’s now assess the impact of the trial on sales.</p>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control sales to match pre-trial trial store sales</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>scaledControlSales <span class="ot">&lt;-</span> measureOverTimeSales[STORE_NBR <span class="sc">==</span> control_store, ][ ,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>controlSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> scalingFactorForControlSales]</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the percentage difference between scaled control sales and trial sales</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: When calculating percentage difference, remember to use absolute difference</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlSales,</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeSales[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> (((totSales.y <span class="sc">-</span> controlSales) <span class="sc">/</span> controlSales)) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the standard deviation of percentage differences during the pre-trial period</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store total sales</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Create a table with sales by store type and month.</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: We only need data for the trial and control store.</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the 5th and 95th percentile for control store sales.</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: The 5th and 95th percentiles can be approximated by using two standard deviations away from the mean.</span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint2: Recall that the variable stdDev earlier calculates standard deviation in percentages, and not dollar sales.</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>                                 ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>                                 ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="do">#### Then, create a combined table with columns from pastSales, pastSales_Controls95 and pastSales_Controls5</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting these in one nice graph</span></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,], </span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), </span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>                <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The results show that the trial in store 86 is not significantly different to its control store in the trial period as the trial store performance lies inside the 5% to 95% confidence interval of the control store in two of the three trial months.</p>
<p>Let’s have a look at assessing this for the number of customers as well.</p>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### This would be a repeat of the steps before for total sales</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control customers to match pre-trial trial store customers</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCust <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)] <span class="sc">/</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>scaledControlCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[STORE_NBR <span class="sc">==</span> control_store,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>                                               ][ , controlCustomers <span class="sc">:</span><span class="er">=</span> nCustomers <span class="sc">*</span> scalingFactorForControlCust</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>                                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>                                                    ]</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="do">#### Calculate the percentage difference between scaled control sales and trial sales</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  scaledControlCustomers[, <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"controlCustomers"</span>)], </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  measureOverTime[STORE_NBR <span class="sc">==</span> trial_store, <span class="fu">c</span>(<span class="st">"nCustomers"</span>, <span class="st">"YEARMONTH"</span>)],</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"YEARMONTH"</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>  )[, percentageDiff <span class="sc">:</span><span class="er">=</span> <span class="fu">abs</span>(controlCustomers<span class="sc">-</span>nCustomers)<span class="sc">/</span>controlCustomers]</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store number of customers</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, nCusts <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>                                          ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>                                          ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence</span></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a><span class="st">interval"</span>]</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>                                         ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>                                         ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastCustomers, pastCustomers_Controls95,</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5)</span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting these in one nice graph</span></span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCusts, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), </span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a>                <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It looks like the number of customers is significantly higher in all of the three months. This seems to suggest that the trial had a significant impact on increasing the number of customers in trial store 86 but as we saw, sales were not significantly higher. We should check with the Category Manager if there were special deals in the trial store that were may have resulted in lower prices, impacting the results.</p>
<section id="supposed-results-1" class="level3">
<h3 class="anchored" data-anchor-id="supposed-results-1">Supposed results</h3>
<section id="visual-checks-1" class="level4">
<h4 class="anchored" data-anchor-id="visual-checks-1">Visual checks</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> <span class="dv">155</span> <span class="co"># Supposed result</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Visual checks on trends based on the drivers</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                                  ][, nCustomers <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(measureOverTimeCusts[, `:=`(Store_type,
ifelse(STORE_NBR == : 66.118321 (type 'double') at RHS position 1
out-of-range(NA) or truncated (precision lost) when assigning to type 'integer'
(column 4 named 'nCustomers')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-of-results-1" class="level4">
<h4 class="anchored" data-anchor-id="comparison-of-results-1">Comparison of results</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control sales to match pre-trial trial store sales</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>scaledControlSales <span class="ot">&lt;-</span> measureOverTimeSales[STORE_NBR <span class="sc">==</span> control_store, ][ , controlSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> scalingFactorForControlSales]</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>scaledControlSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have comparable sales figures for the control store, we can calculate the percentage difference between the scaled control sales and the trial store’s sales during the trial period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the percentage difference between scaled control sales and trial sales</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlSales,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeSales[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> (((totSales.y <span class="sc">-</span> controlSales) <span class="sc">/</span> controlSales)) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff &lt;- merge(</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   scaledControlSales[, .(YEARMONTH, controlSales)], </span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   measureOverTimeSales[STORE_NBR == trial_store, .(YEARMONTH, trialSales = totSales)], </span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   by = "YEARMONTH"</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co"># )[, percentageDiff := ((controlSales / trialSales) - 1) * 100]</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="significance-test-for-sales-1" class="level4">
<h4 class="anchored" data-anchor-id="significance-test-for-sales-1">Significance test for sales</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff]) <span class="co"># 6.801061%</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Note that there are 8 months in the pre-trial period, hence 8 - 1 = 7 degrees of freedom</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores.</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the t-values for the trial months. After that, find the 95th percentile of the t distribution with the appropriate degrees of freedom to check whether the hypothesis is statistically significant.</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: The test statistic here is (x - u)/standard deviation</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>percentageDiff[, tValue <span class="sc">:</span><span class="er">=</span> (percentageDiff <span class="sc">-</span> <span class="dv">0</span>)<span class="sc">/</span>stdDev][, TransactionMonth <span class="sc">:</span><span class="er">=</span> TransactionMonth.x][, .(TransactionMonth, percentageDiff, tValue, <span class="at">significance =</span> (tValue <span class="sc">&gt;</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    TransactionMonth percentageDiff   tValue significance
              &lt;Date&gt;          &lt;num&gt;    &lt;num&gt;       &lt;lgcl&gt;
 1:       2018-07-01       50.05624 5.306184         TRUE
 2:       2018-08-01       33.66956 3.569123         TRUE
 3:       2018-09-01       55.31960 5.864123         TRUE
 4:       2018-10-01       60.21601 6.383165         TRUE
 5:       2018-11-01       54.98863 5.829039         TRUE
 6:       2018-12-01       40.87105 4.332513         TRUE
 7:       2019-01-01       43.23686 4.583299         TRUE
 8:       2019-02-01       69.47991 7.365179         TRUE
 9:       2019-03-01       66.23169 7.020853         TRUE
10:       2019-04-01       46.12787 4.889759         TRUE
11:       2019-05-01       53.43364 5.664203         TRUE
12:       2019-06-01       38.97573 4.131601         TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff[YEARMONTH &gt;= 201902 &amp; YEARMONTH &lt;= 201904, </span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   .(TransactionMonth = TransactionMonth.x, </span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     percentageDiff, </span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     tValue = percentageDiff / stdDev, </span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     significance = (percentageDiff / stdDev) &gt; qt(0.95, df = degreesOfFreedom))]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store total sales</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Create new variables Store_type, totSales and TransactionMonth in the data table.</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### ??? PLOT DOES NOT LOOK RIGHT</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>                                 ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>                                 ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting these in one nice graph</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="significance-test-for-customers-1" class="level4">
<h4 class="anchored" data-anchor-id="significance-test-for-customers-1">Significance test for customers</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### This would be a repeat of the steps before for total sales</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control customers to match pre-trial trial store customers</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Compute a scaling factor to align control store customer counts to our trial store. Then, apply the scaling factor to control store customer counts. Finally, calculate the percentage difference between scaled control store customers and trial customers.</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCust <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>scaledControlCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[STORE_NBR <span class="sc">==</span> control_store, ][ , controlCustomers <span class="sc">:</span><span class="er">=</span> nCustomers <span class="sc">*</span> scalingFactorForControlCust]</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlCustomers,</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeCusts[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> ((nCustomers.y <span class="sc">-</span> controlCustomers) <span class="sc">/</span> controlCustomers) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store number of customers</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, nCusts <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>                                          ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>) </span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>                                          ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>                                         ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>                                         ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="st">interval"</span>]</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastCustomers, pastCustomers_Controls95, pastCustomers_Controls5)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Plot everything into one nice graph.</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: geom_rect creates a rectangle in the plot. Use this to highlight the trial period in our graph.</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCusts, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="trial-store-88" class="level2">
<h2 class="anchored" data-anchor-id="trial-store-88">Trial store 88</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### All over to you now! Your manager has left for a conference call, so you'll be on your own this time.</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Conduct the analysis on trial store 88.</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>measureOverTime <span class="ot">&lt;-</span> data[, .(<span class="at">totSales =</span> <span class="fu">sum</span>(TOT_SALES),</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nCustomers =</span> <span class="fu">uniqueN</span>(LYLTY_CARD_NBR),</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nTxnPerCust =</span> <span class="fu">uniqueN</span>(TXN_ID) <span class="sc">/</span> <span class="fu">uniqueN</span>(LYLTY_CARD_NBR),</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nChipsPerTxn =</span> <span class="fu">sum</span>(TOT_SALES <span class="sc">*</span> PACK_SIZE) <span class="sc">/</span> <span class="fu">uniqueN</span>(TXN_ID),</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">avgPricePerUnit =</span> <span class="fu">sum</span>(TOT_SALES) <span class="sc">/</span> <span class="fu">sum</span>(TOT_SALES <span class="sc">*</span> PACK_SIZE))</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>                        , by <span class="ot">=</span> .(STORE_NBR, YEARMONTH)][<span class="fu">order</span>(STORE_NBR, YEARMONTH)]</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>measureOverTime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      STORE_NBR YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
          &lt;int&gt;     &lt;num&gt;    &lt;num&gt;      &lt;int&gt;       &lt;num&gt;        &lt;num&gt;
   1:         1    201807    188.9         47    1.042553     680.1449
   2:         1    201808    168.4         41    1.000000     747.8268
   3:         1    201809    268.1         57    1.035088     820.5407
   4:         1    201810    175.4         39    1.025641     715.7175
   5:         1    201811    184.8         44    1.022727     733.2489
  ---                                                                 
3161:       272    201902    385.3         44    1.068182    1466.9617
3162:       272    201903    421.9         48    1.062500    1536.5392
3163:       272    201904    445.1         54    1.018519    1323.6982
3164:       272    201905    314.6         34    1.176471    1453.3675
3165:       272    201906    301.9         33    1.090909    1515.6139
      avgPricePerUnit
                &lt;num&gt;
   1:     0.005668060
   2:     0.005492337
   3:     0.005537895
   4:     0.006126719
   5:     0.005600645
  ---                
3161:     0.005588334
3162:     0.005383884
3163:     0.006113725
3164:     0.005411570
3165:     0.005533145</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Use the functions from earlier to calculate the correlation of the sales and number of customers of each potential control store to the trial store</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>trial_store <span class="ot">&lt;-</span> <span class="dv">88</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>corr_nSales <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(measureOverTime, <span class="fu">quote</span>(totSales), trial_store)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>corr_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(measureOverTime, <span class="fu">quote</span>(nCustomers), trial_store)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Use the functions from earlier to calculate the magnitude distance of the sales and number of customers of each potential control store to the trial store</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>magnitude_nSales <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="fu">quote</span>(totSales), trial_store)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>magnitude_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="fu">quote</span>(nCustomers), trial_store)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Create a combined score composed of correlation and magnitude by merging the correlations table and the magnitudes table, for each driver.</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>corr_weight <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>score_nSales <span class="ot">&lt;-</span> <span class="fu">merge</span>(corr_nSales, magnitude_nSales, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))[, scoreNSales <span class="sc">:</span><span class="er">=</span> corr_weight <span class="sc">*</span> corr_measure <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight) <span class="sc">*</span> mag_measure]</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>score_nCustomers <span class="ot">&lt;-</span> <span class="fu">merge</span>(corr_nCustomers, magnitude_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))[, scoreNCust <span class="sc">:</span><span class="er">=</span> corr_weight <span class="sc">*</span> corr_measure <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight) <span class="sc">*</span> mag_measure]</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="do">#### Combine scores across the drivers by merging sales scores and customer scores, and compute a final combined score.</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>score_Control <span class="ot">&lt;-</span> <span class="fu">merge</span>(score_nSales, score_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>))</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>score_Control[, finalControlScore <span class="sc">:</span><span class="er">=</span> scoreNSales <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">+</span> scoreNCust <span class="sc">*</span> <span class="fl">0.5</span>]</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a><span class="do">#### Select control stores based on the highest matching store</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="do">#### (closest to 1 but not the store itself, i.e. the second ranked highest store)</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="do">#### Select control store for trial store 88</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> score_Control[Store1 <span class="sc">==</span> trial_store, </span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>                               ][<span class="fu">order</span>(<span class="sc">-</span>finalControlScore)][<span class="dv">2</span>, Store2]</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>score_Control[Store1 <span class="sc">==</span> trial_store, ][<span class="fu">order</span>(<span class="sc">-</span>finalControlScore)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Store1 Store2 corr_measure.x mag_measure.x scoreNSales corr_measure.y
      &lt;num&gt;  &lt;num&gt;          &lt;num&gt;         &lt;num&gt;       &lt;num&gt;          &lt;num&gt;
  1:     88     88     1.00000000    1.00000000  1.00000000     1.00000000
  2:     88    201     0.60477956    0.87684834  0.80883114     0.18459016
  3:     88     26     0.31509125    0.90088765  0.75443855     0.39509941
  4:     88    237    -0.04972499    0.94267292  0.69457345     0.35168572
  5:     88     95     0.53589120    0.84653356  0.76887297     0.32355868
 ---                                                                      
255:     88     14    -0.15859493    0.02149073 -0.02353069    -0.11193595
256:     88    161    -0.21220372    0.01801167 -0.03954218    -0.05918985
257:     88     52    -0.07609695    0.02110874 -0.00319268    -0.23225565
258:     88    135    -0.38859624    0.01607198 -0.08509507    -0.07158600
259:     88    244    -0.17609673    0.01359743 -0.03382611    -0.35773717
     mag_measure.y   scoreNCust finalControlScore
             &lt;num&gt;        &lt;num&gt;             &lt;num&gt;
  1:    1.00000000  1.000000000        1.00000000
  2:    0.92243851  0.737976420        0.77340378
  3:    0.91894376  0.787982672        0.77121061
  4:    0.97846805  0.821772463        0.75817295
  5:    0.87231229  0.735123887        0.75199843
 ---                                             
255:    0.03308645 -0.003169152       -0.01334992
256:    0.03574539  0.012011581       -0.01376530
257:    0.02994484 -0.035605279       -0.01939898
258:    0.03229839  0.006327290       -0.03938389
259:    0.02153291 -0.073284606       -0.05355536</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># control_store &lt;- 237 # Supposed result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve now found store 237 to be a suitable control store for trial store 88. Again, let’s check visually if the drivers are indeed similar in the period before the trial. We’ll look at total sales first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Visual checks on trends based on the drivers</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### For the period before the trial, create a graph with total sales of the trial store for each month, compared to the control store and other stores.</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Great, the trial and control stores have similar total sales. Next, number of customers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Visual checks on trends based on the drivers</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### For the period before the trial, create a graph with customer counts of the trial store for each month, compared to the control store and other stores.</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>                                  ][, nCustomers <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(measureOverTimeCusts[, `:=`(Store_type,
ifelse(STORE_NBR == : 66.648855 (type 'double') at RHS position 1
out-of-range(NA) or truncated (precision lost) when assigning to type 'integer'
(column 4 named 'nCustomers')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Total number of customers of the control and trial stores are also similar. Let’s now assess the impact of the trial on sales.</p>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control store sales to match pre-trial trial store sales</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>scaledControlSales <span class="ot">&lt;-</span> measureOverTimeSales[STORE_NBR <span class="sc">==</span> control_store, ][ , controlSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> scalingFactorForControlSales]</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>scaledControlSales</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Calculate the absolute percentage difference between scaled control sales and trial sales</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlSales,</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeSales[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> (((totSales.y <span class="sc">-</span> controlSales) <span class="sc">/</span> controlSales)) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store total sales</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>                                 ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>                                 ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a><span class="do">#### Combine the tables pastSales, pastSales_Controls95, pastSales_Controls5</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plot these in one nice graph</span></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,], </span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), </span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>                <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The results show that the trial in store 88 is significantly different to its control store in the trial period as the trial store performance lies outside of the 5% to 95% confidence interval of the control store in two of the three trial months. Let’s have a look at assessing this for number of customers as well.</p>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### This would be a repeat of the steps before for total sales</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control store customers to match pre-trial trial store customers</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCust <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)] <span class="sc">/</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>scaledControlCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[STORE_NBR <span class="sc">==</span> control_store,</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>                                               ][ , controlCustomers <span class="sc">:</span><span class="er">=</span> nCustomers <span class="sc">*</span> scalingFactorForControlCust</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>                                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>                                                    ]</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="do">#### Calculate the absolute percentage difference between scaled control sales and trial sales</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>  scaledControlCustomers[, <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"controlCustomers"</span>)], </span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>  measureOverTime[STORE_NBR <span class="sc">==</span> trial_store, <span class="fu">c</span>(<span class="st">"nCustomers"</span>, <span class="st">"YEARMONTH"</span>)],</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"YEARMONTH"</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>  )[, percentageDiff <span class="sc">:</span><span class="er">=</span> <span class="fu">abs</span>(controlCustomers<span class="sc">-</span>nCustomers)<span class="sc">/</span>controlCustomers]</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store number of customers</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, nCusts <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>                                          ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>                                          ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence</span></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a><span class="st">interval"</span>]</span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>                                         ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>                                         ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastCustomers, pastCustomers_Controls95,</span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5)</span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting these in one nice graph</span></span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCusts, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb87-43"><a href="#cb87-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), </span>
<span id="cb87-44"><a href="#cb87-44" aria-hidden="true" tabindex="-1"></a>                <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb87-45"><a href="#cb87-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb87-46"><a href="#cb87-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Total number of customers in the trial period for the trial store is significantly higher than the control store for two out of three months, which indicates a positive trial effect.</p>
<section id="supposed-results-2" class="level3">
<h3 class="anchored" data-anchor-id="supposed-results-2">Supposed results</h3>
<section id="visual-checks-2" class="level4">
<h4 class="anchored" data-anchor-id="visual-checks-2">Visual checks</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> <span class="dv">237</span> <span class="co"># Supposed result</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Visual checks on trends based on the drivers</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>                                  ][, nCustomers <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>                                      ][YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span> , ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(measureOverTimeCusts[, `:=`(Store_type,
ifelse(STORE_NBR == : 66.187023 (type 'double') at RHS position 1
out-of-range(NA) or truncated (precision lost) when assigning to type 'integer'
(column 4 named 'nCustomers')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-33-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-of-results-2" class="level4">
<h4 class="anchored" data-anchor-id="comparison-of-results-2">Comparison of results</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control sales to match pre-trial trial store sales</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(totSales)]</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Apply the scaling factor</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>scaledControlSales <span class="ot">&lt;-</span> measureOverTimeSales[STORE_NBR <span class="sc">==</span> control_store, ][ , controlSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> scalingFactorForControlSales]</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>scaledControlSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have comparable sales figures for the control store, we can calculate the percentage difference between the scaled control sales and the trial store’s sales during the trial period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the percentage difference between scaled control sales and trial sales</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlSales,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeSales[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> (((totSales.y <span class="sc">-</span> controlSales) <span class="sc">/</span> controlSales)) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff &lt;- merge(</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   scaledControlSales[, .(YEARMONTH, controlSales)], </span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   measureOverTimeSales[STORE_NBR == trial_store, .(YEARMONTH, trialSales = totSales)], </span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   by = "YEARMONTH"</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="co"># )[, percentageDiff := ((controlSales / trialSales) - 1) * 100]</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="significance-test-for-sales-2" class="level4">
<h4 class="anchored" data-anchor-id="significance-test-for-sales-2">Significance test for sales</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff]) <span class="co"># 6.801061%</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Note that there are 8 months in the pre-trial period, hence 8 - 1 = 7 degrees of freedom</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores.</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Calculate the t-values for the trial months. After that, find the 95th percentile of the t distribution with the appropriate degrees of freedom to check whether the hypothesis is statistically significant.</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: The test statistic here is (x - u)/standard deviation</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>percentageDiff[, tValue <span class="sc">:</span><span class="er">=</span> (percentageDiff <span class="sc">-</span> <span class="dv">0</span>)<span class="sc">/</span>stdDev][, TransactionMonth <span class="sc">:</span><span class="er">=</span> TransactionMonth.x][, .(TransactionMonth, percentageDiff, tValue, <span class="at">significance =</span> (tValue <span class="sc">&gt;</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    TransactionMonth percentageDiff    tValue significance
              &lt;Date&gt;          &lt;num&gt;     &lt;num&gt;       &lt;lgcl&gt;
 1:       2018-07-01       111.5873  8.399615         TRUE
 2:       2018-08-01       125.4894  9.446083         TRUE
 3:       2018-09-01       143.9842 10.838258         TRUE
 4:       2018-10-01       123.3401  9.284299         TRUE
 5:       2018-11-01       135.7660 10.219641         TRUE
 6:       2018-12-01       107.3097  8.077627         TRUE
 7:       2019-01-01       114.4567  8.615610         TRUE
 8:       2019-02-01       156.4509 11.776680         TRUE
 9:       2019-03-01       154.5580 11.634188         TRUE
10:       2019-04-01       136.2523 10.256247         TRUE
11:       2019-05-01       126.2129  9.500541         TRUE
12:       2019-06-01       124.2860  9.355499         TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># percentageDiff[YEARMONTH &gt;= 201902 &amp; YEARMONTH &lt;= 201904, </span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   .(TransactionMonth = TransactionMonth.x, </span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     percentageDiff, </span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     tValue = percentageDiff / stdDev, </span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     significance = (percentageDiff / stdDev) &gt; qt(0.95, df = degreesOfFreedom))]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store total sales</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Create new variables Store_type, totSales and TransactionMonth in the data table.</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### ??? PLOT DOES NOT LOOK RIGHT</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTimeSales[, Store_type <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> trial_store, <span class="st">"Trial"</span>, </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(STORE_NBR <span class="sc">==</span> control_store, <span class="st">"Control"</span>, <span class="st">"Other stores"</span>))</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(totSales), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>                                    ][, TransactionMonth <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>                                  ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>                                  ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales[Store_type <span class="sc">==</span> <span class="st">"Control"</span>,</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>                                 ][, totSales <span class="sc">:</span><span class="er">=</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>                                 ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence interval"</span>]</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting these in one nice graph</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total sales by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="significance-test-for-customers-2" class="level4">
<h4 class="anchored" data-anchor-id="significance-test-for-customers-2">Significance test for customers</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### This would be a repeat of the steps before for total sales</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### Scale pre-trial control customers to match pre-trial trial store customers</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Compute a scaling factor to align control store customer counts to our trial store. Then, apply the scaling factor to control store customer counts. Finally, calculate the percentage difference between scaled control store customers and trial customers.</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCust <span class="ot">&lt;-</span> preTrialMeasures[STORE_NBR <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]<span class="sc">/</span>preTrialMeasures[STORE_NBR <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>, <span class="fu">sum</span>(nCustomers)]</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>measureOverTimeCusts <span class="ot">&lt;-</span> measureOverTime</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>scaledControlCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[STORE_NBR <span class="sc">==</span> control_store, ][ , controlCustomers <span class="sc">:</span><span class="er">=</span> nCustomers <span class="sc">*</span> scalingFactorForControlCust]</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> <span class="fu">merge</span>(scaledControlCustomers,</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>                        measureOverTimeCusts[STORE_NBR <span class="sc">==</span> trial_store, ],</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">"YEARMONTH"</span>)[, percentageDiff <span class="sc">:</span><span class="er">=</span> ((nCustomers.y <span class="sc">-</span> controlCustomers) <span class="sc">/</span> controlCustomers) <span class="sc">*</span> <span class="dv">100</span>]</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="Center">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### As our null hypothesis is that the trial period is the same as the pre-trial period, let's take the standard deviation based on the scaled percentage difference in the pre-trial period</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> <span class="fu">sd</span>(percentageDiff[YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> , percentageDiff])</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Trial and control store number of customers</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTimeCusts[, nCusts <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(nCustomers), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"YEARMONTH"</span>, <span class="st">"Store_type"</span>)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>                                      ][Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>), ]</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 95th percentile</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>                                          ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>) </span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>                                          ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 95th % confidence interval"</span>]</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a><span class="do">#### Control store 5th percentile</span></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers[Store_type <span class="sc">==</span> <span class="st">"Control"</span>, </span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>                                         ][, nCusts <span class="sc">:</span><span class="er">=</span> nCusts <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>                                         ][, Store_type <span class="sc">:</span><span class="er">=</span> <span class="st">"Control 5th % confidence</span></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a><span class="st">interval"</span>]</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pastCustomers, pastCustomers_Controls95, pastCustomers_Controls5)</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### Over to you! Plot everything into one nice graph.</span></span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a><span class="do">#### Hint: geom_rect creates a rectangle in the plot. Use this to highlight the trial period in our graph.</span></span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCusts, <span class="at">color =</span> Store_type)) <span class="sc">+</span> </span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment[ YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> ,],</span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span> , <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total number of customers"</span>, <span class="at">title =</span> <span class="st">"Total number of customers by month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-Center">
<figure class="figure">
<p><img src="forage_quantium_task2_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid quarto-figure quarto-figure-Center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Good work! We’ve found control stores 233, 155, 237 for trial stores 77, 86 and 88 respectively.</p>
<p>The results for trial stores 77 and 88 during the trial period show a significant difference in at least two of the three trial months but this is not the case for trial store 86. We can check with the client if the implementation of the trial was different in trial store 86 but overall, the trial shows a significant increase in sales. Now that we have finished our analysis, we can prepare our presentation to the Category Manager.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>